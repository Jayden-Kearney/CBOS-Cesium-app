<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Lilydale to Warburton Trail - 3D Explorer</title>
<style>
html, body, #cesiumContainer {
  width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
}
#legend {
  position: absolute; top: 10px; left: 10px;
  background: rgba(255,255,255,0.9); padding: 10px; border-radius: 8px;
  font-size: 13px;
}
</style>
<script src="https://cesium.com/downloads/cesiumjs/releases/1.128/Build/Cesium/Cesium.js"></script>
<link href="https://cesium.com/downloads/cesiumjs/releases/1.128/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
</head>
<body>
<div id="cesiumContainer"></div>
<div id="legend">
  <b>Lilydale–Warburton Trail</b><br>
  <span style="color:gray;">●</span> Car park <br>
  <span style="color:blue;">●</span> Toilet <br>
  <span style="color:green;">●</span> Picnic tables <br>
  <span style="color:orange;">●</span> Other Waypoints
</div>

<script type="module">
async function init() {
  // 1. Cesium ion token
  Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI5ZDVkNGE4MC1hYzZiLTQzZjMtOGI3OS1hNjYzYzFlYjI3MzgiLCJpZCI6MzI4NDMxLCJpYXQiOjE3NTg3NzIyMDF9.hOHLE4i1EjxEebTNxMVkivb3ErDKSc4a-2-e0r6mdLQ";

  // 2. Viewer with terrain
  const viewer = new Cesium.Viewer("cesiumContainer", {
    terrainProvider: await Cesium.createWorldTerrainAsync()
  });

  // Add Google Photorealistic 3D Tiles
  viewer.scene.primitives.add(await Cesium.createGooglePhotorealistic3DTileset());

  // 3. Trail GeoJSON
  const trailDS = await Cesium.GeoJsonDataSource.load("Lilydale_to_Warburton_Rail_Trail.geojson", { clampToGround: true });
  viewer.dataSources.add(trailDS);
  trailDS.entities.values.forEach(e => {
    if (e.polyline) {
      e.polyline.width = 6;
      e.polyline.material = Cesium.Color.WHITE;
      e.polyline.clampToGround = true;
    }
  });
  viewer.zoomTo(trailDS);

  // 4. Waypoints GeoJSON
  const wpDS = await Cesium.GeoJsonDataSource.load("Lilydale_to_Warburton_Rail_Trail_waypoints.geojson", { clampToGround: true });
  viewer.dataSources.add(wpDS);

  wpDS.entities.values.forEach(e => {
    if (e.position) {  // only Point features
      const name = e.properties?.Name?.getValue() || "";
      const n = name.toLowerCase();

      let color = Cesium.Color.ORANGE;
      if (n.includes("car park")) color = Cesium.Color.GRAY;
      else if (n.includes("toilet")) color = Cesium.Color.BLUE;
      else if (n.includes("picnic")) color = Cesium.Color.GREEN;

      // Make point visible with correct color
      e.point = new Cesium.PointGraphics({
        pixelSize: 12,
        color: color,
        outlineColor: Cesium.Color.BLACK,
        outlineWidth: 2,
        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
      });

      // Add label, initially hidden
      e.label = new Cesium.LabelGraphics({
        text: name,
        font: "14px sans-serif",
        fillColor: Cesium.Color.BLACK,
        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
        outlineWidth: 2,
        verticalOrigin: Cesium.VerticalOrigin.TOP,
        pixelOffset: new Cesium.Cartesian2(0, -15),
        showBackground: true,
        backgroundColor: new Cesium.Color(1,1,1,0.7),
        scale: 0.6,
        show: false
      });
    }
  });

  // 5. Click handler to toggle labels
  const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
  handler.setInputAction((movement) => {
    const picked = viewer.scene.pick(movement.position);

    // Hide all labels first
    wpDS.entities.values.forEach(entity => {
      if (entity.label) entity.label.show = false;
    });

    // If clicked on a waypoint, show its label
    if (Cesium.defined(picked) && picked.id && picked.id.label) {
      picked.id.label.show = true;
    }
  }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
}

init();
</script>
</body>
</html>

